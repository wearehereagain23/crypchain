<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Cryp-Chain</title>
    <link rel="icon" href="./assets/badge/logo2.png">

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <link rel="stylesheet" href="./css/nav.css">
    <link rel="stylesheet" href="./css/watchlist.css">

    <style>
        /* 1. RESTORE VISIBILITY FOR DARK THEME */
        .watchlist-card h3,
        .watchlist-item .asset-name,
        .watchlist-item .price {
            color: #ffffff !important;
        }

        /* 2. CHART AREA */
        .chart-container {
            background: var(--panel);
            border: 1px solid var(--glass);
            border-radius: 24px;
            padding: 20px;
            margin-bottom: 24px;
        }

        #chartCanvas {
            width: 100%;
            height: 400px;
        }

        /* 3. WATCHLIST AREA */
        .watchlist-card {
            background: var(--panel);
            border: 1px solid var(--glass);
            border-radius: 24px;
            padding: 20px;
        }

        .watchlist-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid var(--glass);
        }

        .asset-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .price-info {
            text-align: right;
        }

        .change.plus {
            color: var(--bull);
        }

        .change.minus {
            color: var(--bear);
        }

        @media (max-width: 1024px) {
            #chartCanvas {
                height: 280px;
            }
        }
    </style>
</head>

<body>
    <div class="app">
        <nav class="side-nav">
            <a href="index.html" class="nav-item"><i class="ph ph-chart-line"></i><span>CHART</span></a>
            <a href="market.html" class="nav-item"><i class="ph ph-arrows-left-right"></i><span>MARKET</span></a>
            <a href="profile.html" class="nav-item"><i class="ph ph-user"></i><span>PROFILE</span></a>
            <a href="history.html" class="nav-item"><i
                    class="ph ph-clock-counter-clockwise"></i><span>HISTORY</span></a>
            <div class="nav-item" style="margin-top:auto" onclick="handleLogout()">
                <i class="ph ph-sign-out"></i><span>LOGOUT</span>
            </div>
        </nav>

        <div class="main-content">
            <div class="layout">
                <div class="center">
                    <div class="card">
                        <canvas id="chartCanvas"></canvas>
                    </div>
                </div>

                <div class="watch">
                    <div class="wl-head">
                        <h3>Watchlist</h3>
                    </div>
                    <div class="wl-list" id="watchlistItems"></div>
                </div>
            </div>
        </div>

        <nav class="mobile-nav">
            <a href="index.html" class="nav-item active">
                <i class="ph ph-chart-line"></i>
                <span>Chart</span>
            </a>
            <a href="market.html" class="nav-item">
                <i class="ph ph-arrows-left-right"></i>
                <span>Market</span>
            </a>
            <a href="profile.html" class="nav-item">
                <i class="ph ph-user"></i>
                <span>User</span>
            </a>
            <a href="history.html" class="nav-item ">
                <i class="ph ph-clock-counter-clockwise"></i>
                <span>History</span>
            </a>
            <div class="nav-item" onclick="handleLogout()">
                <i class="ph ph-sign-out"></i>
                <span>Exit</span>
            </div>
        </nav>
    </div>

    <script src="/socket.io/socket.io.js"></script>

    <script type="module">
        import { supabase } from './js/chart.supabase.js';
        import { initNavigation } from './js/nav.js';
        import { initChart, setActiveSymbol } from './js/chart-engine.js';
        import { renderWatchlist } from './js/watchlist.js';
        import { getUserIdFromUrl } from './js/utilities.js';
        import { USER_TABLE } from '../config.js';

        /**
         * Rule: Full function replacement.
         * Logic: Validates session and listens for Realtime login_ID changes to force logout.
         * Debug: Explicit logs for session invalidation.
         */
        import { checkSecurityIntegrity } from './js/notifications.js';

        // Check every 5 seconds
        setInterval(checkSecurityIntegrity, 5000);


        async function validateAndStart() {
            initNavigation();

            const userId = getUserIdFromUrl(); // This is the UUID text from URL
            const savedLoginId = localStorage.getItem('login_ID');

            // 1. Initial Guard
            if (!userId || !savedLoginId) {
                console.error("[DEBUG] Missing session data. Redirecting to login.");
                window.location.href = '../login.html';
                return;
            }

            try {
                // 2. Initial Server Validation
                const { data: user, error } = await supabase
                    .from(USER_TABLE)
                    .select('uuid, login_ID')
                    .eq('uuid', userId)
                    .single();

                if (error || !user || user.login_ID !== savedLoginId) {
                    console.error("[DEBUG] Auth Mismatch or User Not Found.");
                    logout();
                    return;
                }

                // 3. Realtime Listener for Instant Logout
                // Watches for any UPDATE on THIS specific user's row
                supabase.channel('session-monitor')
                    .on(
                        'postgres_changes',
                        {
                            event: 'UPDATE',
                            schema: 'public',
                            table: USER_TABLE,
                            filter: `uuid=eq.${userId}`
                        },
                        (payload) => {
                            console.log("[DEBUG] Realtime Update Detected:", payload.new);

                            // If the login_ID in the database changed, it's an instant logout
                            if (payload.new.login_ID !== savedLoginId) {
                                console.warn("[DEBUG] login_ID changed in DB. Forcing Logout.");
                                logout();
                            }
                        }
                    )
                    .subscribe();

                // 4. Initialize Page Components
                renderWatchlist();
                await initChart('chartCanvas');

                window.addEventListener('resize', () => { initChart('chartCanvas'); });
                window.changeSymbol = async (symbol) => { await setActiveSymbol(symbol); };

                console.log("[DEBUG] Chart initialized and monitoring session...");

            } catch (e) {
                console.error("[DEBUG] Critical Boot Error:", e);
                window.location.href = '../login.html';
            }
        }

        /**
         * Simple Logout Helper
         */
        function logout() {
            localStorage.removeItem('login_ID');
            localStorage.removeItem('user_uuid');
            window.location.href = '../login.html';
        }

        validateAndStart();
    </script>

</body>

</html>