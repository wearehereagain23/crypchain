<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Cryp-Chain</title>
    <link rel="icon" href="./chart/assets/badge/logo2.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
    <style>
        :root {
            --bg: #0b1220;
            --accent: #7c5cff;
            --glass: rgba(124, 92, 255, 0.05);
        }

        body {
            background: var(--bg);
            color: #fff;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            font-family: 'Inter', sans-serif;
        }

        /* Background Glows */
        .glow {
            position: absolute;
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(124, 92, 255, 0.1) 0%, transparent 70%);
            z-index: -1;
        }

        .logo-container {
            text-align: center;
        }

        .main-logo {
            width: 120px;
            filter: drop-shadow(0 0 15px rgba(124, 92, 255, 0.5));
            animation: pulseLogo 2s infinite ease-in-out;
        }

        .status-text {
            margin-top: 20px;
            font-size: 10px;
            letter-spacing: 3px;
            text-transform: uppercase;
            color: var(--accent);
            opacity: 0.7;
        }

        /* Notification Overlay */
        #notify-prompt {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(11, 18, 32, 0.8);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 40px;
            border-radius: 24px;
            text-align: center;
            max-width: 400px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
        }

        @keyframes pulseLogo {
            0% {
                transform: scale(1);
                opacity: 0.8;
            }

            50% {
                transform: scale(1.05);
                opacity: 1;
            }

            100% {
                transform: scale(1);
                opacity: 0.8;
            }
        }

        /* Fix for the tiny button on iOS */
        .btn {
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 16px;
            font-weight: 700;
            font-size: 16px;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;

            /* CRITICAL FOR MOBILE: Minimum height of 60px for thumbs */
            min-height: 60px;
            width: 100%;
            margin-top: 25px;
            padding: 15px 30px !important;

            /* Prevents default iOS zooming/tapping behaviors */
            touch-action: manipulation;
            box-shadow: 0 10px 20px rgba(124, 92, 255, 0.3);
        }

        .btn:active {
            transform: scale(0.98);
            opacity: 0.9;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>

<body>

    <body>
        <div class="glow"></div>
        <div class="logo-container">
            <img src="./chart/assets/badge/logo.png" class="main-logo" alt="Logo">
            <div class="status-text" id="loader">Establishing Encrypted Tunnel...</div>
        </div>

        <div id="notify-prompt" class="hidden animate__animated animate__fadeIn">
            <div class="glass-card">
                <h2 style="color: var(--accent); margin-bottom: 10px;">Getting Stared</h2>
                <p style="font-size: 14px; color: #9aa4b2; margin-bottom: 30px;">
                    Cryp-Chain requires real-time signal authorization. Please enable notifications to synchronize with
                    the trading terminal.
                </p>
                <button class="btn" id="enableBtn" style="width: 100%; padding: 15px;">AUTHORIZE TERMINAL</button>
            </div>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <script type="module">
            // Use your existing client to keep connection settings consistent
            import { supabase } from './chart/js/chart.supabase.js';
            import { USER_TABLE } from './config.js';

            // Toggle the visibility of the authorization overlay
            async function showEnableNotificationUI() {
                const prompt = document.getElementById('notify-prompt');
                const enableBtn = document.getElementById('enableBtn');

                if (prompt) {
                    prompt.classList.remove('hidden');
                    prompt.style.display = 'flex';
                }

                enableBtn.onclick = async () => {
                    // Disable button to prevent double-taps on iOS
                    enableBtn.disabled = true;
                    enableBtn.innerText = "AUTHORIZING...";

                    const permission = await Notification.requestPermission();

                    if (permission === 'granted') {
                        window.location.href = './login.html';
                    } else {
                        enableBtn.disabled = false;
                        enableBtn.innerText = "ENABLE TERMINAL";
                        Swal.fire({
                            title: 'Access Denied',
                            text: 'System authorization requires notification permissions.',
                            icon: 'warning',
                            background: '#0e1620',
                            color: '#fff',
                            confirmButtonColor: '#7c5cff'
                        });
                    }
                };
            }

            async function runSecurityCheck() {
                // 1. Service Worker Check
                if (!('serviceWorker' in navigator)) {
                    document.body.innerHTML = "<div class='status-text'>Browser Incompatible</div>";
                    return;
                }

                try {
                    await navigator.serviceWorker.register('/sw.js');
                } catch (e) {
                    console.warn("SW Registration delay:", e);
                }

                // 2. Gatekeeper Logic
                if (Notification.permission !== 'granted') {
                    showEnableNotificationUI();
                } else {
                    // If permission is already granted, we don't need the splash.
                    // Go straight to login to identify the user.
                    window.location.href = './login.html';
                }
            }

            // Initialize on load
            window.addEventListener('DOMContentLoaded', runSecurityCheck);
        </script>
    </body>

</html>